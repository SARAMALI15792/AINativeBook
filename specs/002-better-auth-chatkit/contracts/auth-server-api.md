# Auth Server API Contract (Better-Auth Node.js)

**Base URL**: `http://localhost:3001` (dev) / `https://auth.intellistack.app` (prod)

## OIDC Discovery

### GET `/.well-known/openid-configuration`
Standard OIDC discovery document. Auto-generated by Better-Auth OIDC Provider plugin.

**Response** `200 OK`:
```json
{
  "issuer": "https://auth.intellistack.app",
  "authorization_endpoint": "https://auth.intellistack.app/oauth2/authorize",
  "token_endpoint": "https://auth.intellistack.app/oauth2/token",
  "jwks_uri": "https://auth.intellistack.app/.well-known/jwks.json",
  "userinfo_endpoint": "https://auth.intellistack.app/api/auth/userinfo",
  "response_types_supported": ["code"],
  "grant_types_supported": ["authorization_code", "refresh_token"],
  "subject_types_supported": ["public"],
  "id_token_signing_alg_values_supported": ["RS256"],
  "scopes_supported": ["openid", "email", "profile"],
  "code_challenge_methods_supported": ["S256"]
}
```

### GET `/.well-known/jwks.json`
JWKS endpoint for RS256 public key distribution.

**Response** `200 OK`:
```json
{
  "keys": [
    {
      "kty": "RSA",
      "kid": "...",
      "use": "sig",
      "alg": "RS256",
      "n": "...",
      "e": "AQAB"
    }
  ]
}
```

## Authentication Endpoints (Better-Auth managed)

### POST `/api/auth/sign-up/email`
Register a new user with email and password.

**Request**:
```json
{
  "name": "Jane Doe",
  "email": "jane@example.com",
  "password": "SecurePass123!"
}
```

**Response** `200 OK`:
```json
{
  "user": {
    "id": "uuid",
    "name": "Jane Doe",
    "email": "jane@example.com",
    "emailVerified": false,
    "image": null,
    "role": "student",
    "createdAt": "2026-02-11T10:00:00Z"
  },
  "session": {
    "id": "session-id",
    "token": "session-token",
    "expiresAt": "2026-02-18T10:00:00Z"
  }
}
```

**Errors**: `422` validation error, `409` email already exists

### POST `/api/auth/sign-in/email`
Sign in with email and password.

**Request**:
```json
{
  "email": "jane@example.com",
  "password": "SecurePass123!"
}
```

**Response** `200 OK`: Same shape as sign-up response.

**Errors**: `401` invalid credentials, `403` account locked (FR-007), `403` email not verified

### POST `/api/auth/sign-in/social`
Initiate OAuth flow (Google or GitHub).

**Request**:
```json
{
  "provider": "google",
  "callbackURL": "http://localhost:3000/auth/callback"
}
```

**Response** `200 OK`:
```json
{
  "url": "https://accounts.google.com/o/oauth2/v2/auth?...",
  "redirect": true
}
```

### GET `/api/auth/callback/{provider}`
OAuth callback handler. Better-Auth processes the callback, creates/links user, sets session cookie, and redirects to the frontend.

### POST `/api/auth/sign-out`
Sign out and invalidate session.

**Headers**: `Cookie: better-auth.session_token=...`

**Response** `200 OK`:
```json
{ "success": true }
```

### GET `/api/auth/get-session`
Get current session and user info.

**Headers**: `Cookie: better-auth.session_token=...`

**Response** `200 OK`:
```json
{
  "session": {
    "id": "session-id",
    "userId": "user-id",
    "expiresAt": "2026-02-18T10:00:00Z"
  },
  "user": {
    "id": "user-id",
    "name": "Jane Doe",
    "email": "jane@example.com",
    "emailVerified": true,
    "image": "https://...",
    "role": "student"
  }
}
```

**Errors**: `401` no valid session

### POST `/api/auth/forget-password`
Request password reset email.

**Request**:
```json
{
  "email": "jane@example.com",
  "redirectTo": "http://localhost:3000/reset-password"
}
```

**Response** `200 OK`: Always returns success (no email enumeration, FR-008/US-5).

### POST `/api/auth/reset-password`
Reset password with token.

**Request**:
```json
{
  "token": "reset-token-from-email",
  "newPassword": "NewSecurePass456!"
}
```

**Response** `200 OK`:
```json
{ "success": true }
```

**Errors**: `400` invalid/expired token, `422` password too weak

### POST `/api/auth/verify-email`
Verify email address with token from verification email.

**Request**:
```json
{
  "token": "verification-token"
}
```

**Response** `200 OK`:
```json
{ "success": true }
```

## Admin Endpoints (Better-Auth admin plugin)

### POST `/api/auth/admin/set-role`
Assign role to user. Requires admin role.

**Request**:
```json
{
  "userId": "target-user-id",
  "role": "instructor"
}
```

**Response** `200 OK`:
```json
{
  "user": { "id": "...", "role": "instructor" }
}
```

**Errors**: `403` not admin, `404` user not found

## JWT Access Token Claims

```json
{
  "sub": "user-id",
  "iss": "https://auth.intellistack.app",
  "aud": "intellistack",
  "iat": 1707649200,
  "exp": 1707670800,
  "email": "jane@example.com",
  "name": "Jane Doe",
  "role": "student",
  "email_verified": true
}
```

- **Algorithm**: RS256
- **Access Token TTL**: 6 hours (FR-011)
- **Refresh Token TTL**: 7 days (FR-011)
