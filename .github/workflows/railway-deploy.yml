# IntelliStack — Railway Deployment
#
# Triggers on push to main. Each job runs only when its service's
# files change, and deploys the corresponding Railway service.
#
# Required GitHub Secrets (add via repo → Settings → Secrets):
#   RAILWAY_TOKEN — Railway API token (generate with: railway tokens create)

name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # ── Detect which services changed ──────────────────────────────
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      auth: ${{ steps.filter.outputs.auth }}
      content: ${{ steps.filter.outputs.content }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'intellistack/backend/**'
              - 'intellistack/backend/Dockerfile'
              - 'intellistack/backend/railway.toml'
            auth:
              - 'intellistack/auth-server/**'
              - 'intellistack/auth-server/railway.toml'
            content:
              - 'intellistack/content/**'
              - 'intellistack/content/railway.toml'

  # ── Deploy Backend ─────────────────────────────────────────────
  deploy-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy Backend to Railway
        run: railway up --service backend --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ── Deploy Auth Server ─────────────────────────────────────────
  deploy-auth:
    needs: changes
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy Auth Server to Railway
        run: railway up --service auth-server --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ── Deploy Content Site ────────────────────────────────────────
  deploy-content:
    needs: changes
    if: needs.changes.outputs.content == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      - name: Deploy Content to Railway
        run: railway up --service content --detach
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
